{% extends 'admin_panel/base.html' %}
{% load static %}

{% block title %}Moderдь модерации - HandshakeMe Админ-панель{% endblock %}

{% block page_title %}Модерация контента{% endblock %}

{% block content %}
{% csrf_token %}
<!-- Статистика модерации -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Ожидает модерации</h6>
                        <h3 class="mb-0">{{ stats.total_pending }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-clock-history fs-2"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Срочные</h6>
                        <h3 class="mb-0">{{ stats.urgent_pending }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-exclamation-triangle fs-2"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Назначено мне</h6>
                        <h3 class="mb-0">{{ stats.assigned_to_me }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-person-check fs-2"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-secondary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Без назначения</h6>
                        <h3 class="mb-0">{{ stats.unassigned }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-person-x fs-2"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Фильтры и действия -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-funnel me-2"></i>
                    Фильтры и действия
                </h5>
            </div>
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-2">
                        <label for="status" class="form-label">Статус</label>
                        <select name="status" id="status" class="form-select">
                            <option value="">Все статусы</option>
                            {% for value, label in status_choices %}
                                <option value="{{ value }}" {% if current_filters.status == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="priority" class="form-label">Приоритет</label>
                        <select name="priority" id="priority" class="form-select">
                            <option value="">Все приоритеты</option>
                            {% for value, label in priority_choices %}
                                <option value="{{ value }}" {% if current_filters.priority == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="content_type" class="form-label">Тип контента</label>
                        <select name="content_type" id="content_type" class="form-select">
                            <option value="">Все типы</option>
                            {% for content_type in content_types %}
                                <option value="{{ content_type }}" {% if current_filters.content_type == content_type %}selected{% endif %}>
                                    {% if content_type == 'project' %}Проект
                                    {% elif content_type == 'advertisement' %}Объявление
                                    {% elif content_type == 'review' %}Отзыв
                                    {% elif content_type == 'user' %}Пользователь
                                    {% else %}{{ content_type|title }}
                                    {% endif %}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="assigned_to" class="form-label">Назначено</label>
                        <select name="assigned_to" id="assigned_to" class="form-select">
                            <option value="">Все модераторы</option>
                            <option value="unassigned" {% if current_filters.assigned_to == 'unassigned' %}selected{% endif %}>Без назначения</option>
                            <option value="me" {% if current_filters.assigned_to == 'me' %}selected{% endif %}>Мне</option>
                            {% for moderator in moderators %}
                                <option value="{{ moderator.id }}" {% if current_filters.assigned_to == moderator.id|stringformat:"s" %}selected{% endif %}>
                                    {{ moderator.get_full_name|default:moderator.email }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="bi bi-search me-1"></i>
                            Применить
                        </button>
                        <a href="{% url 'admin_panel:moderation' %}" class="btn btn-outline-secondary me-2">
                            <i class="bi bi-x-circle me-1"></i>
                            Сброс
                        </a>
                        <button type="button" class="btn btn-success" onclick="detectSuspiciousContent()">
                            <i class="bi bi-shield-exclamation me-1"></i>
                            Автопоиск
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!
<!-- Массовые действия -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body py-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAll">
                        <label class="form-check-label" for="selectAll">
                            Выбрать все
                        </label>
                    </div>
                    <div class="btn-group" id="bulkActions" style="display: none;">
                        <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-gear me-1"></i>
                            Массовые действия
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="bulkAssign('auto')">
                                <i class="bi bi-shuffle me-2"></i>Автоназначение
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            {% for moderator in moderators %}
                            <li><a class="dropdown-item" href="#" onclick="bulkAssign({{ moderator.id }})">
                                <i class="bi bi-person me-2"></i>{{ moderator.get_full_name|default:moderator.email }}
                            </a></li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Очередь модерации -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-shield-exclamation me-2"></i>
                    Очередь модерации ({{ page_obj.paginator.count }})
                </h5>
                <div class="btn-group">
                    <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-download me-1"></i>
                        Экспорт
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#"><i class="bi bi-file-earmark-excel me-2"></i>Excel</a></li>
                        <li><a class="dropdown-item" href="#"><i class="bi bi-file-earmark-text me-2"></i>CSV</a></li>
                    </ul>
                </div>
            </div>
            <div class="card-body p-0">
                {% if queue_items %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th width="40">
                                        <input type="checkbox" class="form-check-input" id="selectAllTable">
                                    </th>
                                    <th>Контент</th>
                                    <th>Приоритет</th>
                                    <th>Статус</th>
                                    <th>Назначен</th>
                                    <th>Создан</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in queue_items %}
                                <tr class="{% if item.priority == 'urgent' %}table-danger{% elif item.priority == 'high' %}table-warning{% endif %}">
                                    <td>
                                        <input type="checkbox" class="form-check-input queue-item-checkbox" value="{{ item.id }}">
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="me-3">
                                                {% if item.content_type.model == 'project' %}
                                                    <i class="bi bi-briefcase fs-4 text-primary"></i>
                                                {% elif item.content_type.model == 'advertisement' %}
                                                    <i class="bi bi-megaphone fs-4 text-info"></i>
                                                {% elif item.content_type.model == 'review' %}
                                                    <i class="bi bi-star fs-4 text-warning"></i>
                                                {% elif item.content_type.model == 'user' %}
                                                    <i class="bi bi-person fs-4 text-secondary"></i>
                                                {% else %}
                                                    <i class="bi bi-file-text fs-4 text-muted"></i>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <div class="fw-medium">
                                                    {% if item.content_type.model == 'project' %}Проект
                                                    {% elif item.content_type.model == 'advertisement' %}Объявление
                                                    {% elif item.content_type.model == 'review' %}Отзыв
                                                    {% elif item.content_type.model == 'user' %}Пользователь
                                                    {% else %}{{ item.content_type.model|title }}
                                                    {% endif %}
                                                    #{{ item.object_id }}
                                                </div>
                                                <small class="text-muted">
                                                    {% if item.content_object %}
                                                        {{ item.content_object|truncatechars:50 }}
                                                    {% else %}
                                                        Объект удален
                                                    {% endif %}
                                                </small>
                                                {% if item.reason %}
                                                    <br><small class="text-danger">{{ item.reason|truncatechars:30 }}</small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        {% if item.priority == 'urgent' %}
                                            <span class="badge bg-danger">Срочный</span>
                                        {% elif item.priority == 'high' %}
                                            <span class="badge bg-warning">Высокий</span>
                                        {% elif item.priority == 'normal' %}
                                            <span class="badge bg-primary">Обычный</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Низкий</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.status == 'pending' %}
                                            <span class="badge bg-warning">Ожидает</span>
                                        {% elif item.status == 'approved' %}
                                            <span class="badge bg-success">Одобрено</span>
                                        {% elif item.status == 'rejected' %}
                                            <span class="badge bg-danger">Отклонено</span>
                                        {% elif item.status == 'needs_review' %}
                                            <span class="badge bg-info">Требует проверки</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.assigned_to %}
                                            <div class="d-flex align-items-center">
                                                <i class="bi bi-person-check text-success me-2"></i>
                                                <span>{{ item.assigned_to.get_full_name|default:item.assigned_to.email }}</span>
                                            </div>
                                        {% else %}
                                            <span class="text-muted">
                                                <i class="bi bi-person-x me-1"></i>
                                                Не назначен
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ item.created_at|date:"d.m.Y H:i" }}</small>
                                        {% if item.moderated_at %}
                                            <br><small class="text-muted">Модерирован: {{ item.moderated_at|date:"d.m.Y H:i" }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{% url 'admin_panel:moderation_detail' item.id %}" class="btn btn-outline-primary" title="Просмотр">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            {% if item.status == 'pending' %}
                                                <button class="btn btn-outline-success" title="Одобрить" onclick="moderateContent('{{ item.id }}', 'approve')">
                                                    <i class="bi bi-check-circle"></i>
                                                </button>
                                                <button class="btn btn-outline-danger" title="Отклонить" onclick="moderateContent('{{ item.id }}', 'reject')">
                                                    <i class="bi bi-x-circle"></i>
                                                </button>
                                                <div class="btn-group">
                                                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" title="Еще">
                                                        <i class="bi bi-three-dots"></i>
                                                    </button>
                                                    <ul class="dropdown-menu">
                                                        <li><a class="dropdown-item" href="#" onclick="moderateContent('{{ item.id }}', 'needs_review')">
                                                            <i class="bi bi-question-circle me-2"></i>Требует проверки
                                                        </a></li>
                                                        <li><hr class="dropdown-divider"></li>
                                                        <li><a class="dropdown-item" href="#" onclick="assignModerator('{{ item.id }}')">
                                                            <i class="bi bi-person-plus me-2"></i>Назначить модератора
                                                        </a></li>
                                                    </ul>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Пагинация -->
                    {% if page_obj.has_other_pages %}
                        <div class="card-footer">
                            <nav aria-label="Пагинация очереди модерации">
                                <ul class="pagination justify-content-center mb-0">
                                    {% if page_obj.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Первая</a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Предыдущая</a>
                                        </li>
                                    {% endif %}
                                    
                                    <li class="page-item active">
                                        <span class="page-link">{{ page_obj.number }} из {{ page_obj.paginator.num_pages }}</span>
                                    </li>
                                    
                                    {% if page_obj.has_next %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Следующая</a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Последняя</a>
                                        </li>
                                    {% endif %}
                                </ul>
                            </nav>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-shield-exclamation fs-1 text-muted mb-3"></i>
                        <h5 class="text-muted">Очередь модерации пуста</h5>
                        <p class="text-muted">Нет контента, ожидающего модерации</p>
                        <button class="btn btn-primary" onclick="detectSuspiciousContent()">
                            <i class="bi bi-shield-exclamation me-2"></i>
                            Запустить автопоиск
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
<!-- Модальные окна -->
<!-- Модальное окно для модерации контента -->
<div class="modal fade" id="moderationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="moderationModalTitle">Модерация контента</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="moderationModalBody">
                <!-- Содержимое будет заполнено через JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="confirmModerationBtn">Подтвердить</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для назначения модератора -->
<div class="modal fade" id="assignModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Назначить модератора</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="moderatorSelect" class="form-label">Выберите модератора</label>
                    <select class="form-select" id="moderatorSelect">
                        <option value="">Выберите модератора</option>
                        <option value="unassign">Снять назначение</option>
                        {% for moderator in moderators %}
                            <option value="{{ moderator.id }}">{{ moderator.get_full_name|default:moderator.email }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="confirmAssignBtn">Назначить</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% bl
{% block extra_js %}
<script>
let currentQueueId = null;

// Функции для работы с чекбоксами
document.addEventListener('DOMContentLoaded', function() {
    const selectAll = document.getElementById('selectAll');
    const selectAllTable = document.getElementById('selectAllTable');
    const checkboxes = document.querySelectorAll('.queue-item-checkbox');
    const bulkActions = document.getElementById('bulkActions');
    
    // Синхронизация чекбоксов "Выбрать все"
    function syncSelectAll() {
        const checkedCount = document.querySelectorAll('.queue-item-checkbox:checked').length;
        const totalCount = checkboxes.length;
        
        selectAll.checked = checkedCount === totalCount && totalCount > 0;
        selectAllTable.checked = checkedCount === totalCount && totalCount > 0;
        selectAll.indeterminate = checkedCount > 0 && checkedCount < totalCount;
        selectAllTable.indeterminate = checkedCount > 0 && checkedCount < totalCount;
        
        // Показываем/скрываем массовые действия
        bulkActions.style.display = checkedCount > 0 ? 'block' : 'none';
    }
    
    // Обработчики для чекбоксов "Выбрать все"
    [selectAll, selectAllTable].forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            checkboxes.forEach(cb => cb.checked = this.checked);
            syncSelectAll();
        });
    });
    
    // Обработчики для индивидуальных чекбоксов
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', syncSelectAll);
    });
    
    // Инициализация
    syncSelectAll();
});

// Функция модерации контента
function moderateContent(queueId, action) {
    currentQueueId = queueId;
    const modal = new bootstrap.Modal(document.getElementById('moderationModal'));
    const title = document.getElementById('moderationModalTitle');
    const body = document.getElementById('moderationModalBody');
    const confirmBtn = document.getElementById('confirmModerationBtn');
    
    let actionText = '';
    let bodyContent = '';
    
    if (action === 'approve') {
        actionText = 'Одобрить контент';
        title.textContent = 'Одобрение контента';
        confirmBtn.className = 'btn btn-success';
        bodyContent = `
            <p>Вы уверены, что хотите <strong>одобрить</strong> этот контент?</p>
            <div class="mb-3">
                <label for="moderationNotes" class="form-label">Примечания (необязательно)</label>
                <textarea class="form-control" id="moderationNotes" rows="3" placeholder="Добавьте комментарий к решению..."></textarea>
            </div>
        `;
    } else if (action === 'reject') {
        actionText = 'Отклонить контент';
        title.textContent = 'Отклонение контента';
        confirmBtn.className = 'btn btn-danger';
        bodyContent = `
            <p>Вы уверены, что хотите <strong>отклонить</strong> этот контент?</p>
            <div class="mb-3">
                <label for="rejectionReason" class="form-label">Причина отклонения <span class="text-danger">*</span></label>
                <select class="form-select" id="rejectionReason" required>
                    <option value="">Выберите причину</option>
                    <option value="inappropriate_content">Неподходящий контент</option>
                    <option value="spam">Спам</option>
                    <option value="offensive_language">Оскорбительные выражения</option>
                    <option value="false_information">Ложная информация</option>
                    <option value="copyright_violation">Нарушение авторских прав</option>
                    <option value="other">Другое</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="moderationNotes" class="form-label">Дополнительные примечания</label>
                <textarea class="form-control" id="moderationNotes" rows="3" placeholder="Подробное объяснение причины отклонения..."></textarea>
            </div>
        `;
    }
    
    body.innerHTML = bodyContent;
    confirmBtn.textContent = actionText;
    
    confirmBtn.onclick = function() {
        performModeration(action);
    };
    
    modal.show();
}
// Выполнение модерации
function performModeration(action) {
    const notes = document.getElementById('moderationNotes')?.value || '';
    const reason = document.getElementById('rejectionReason')?.value || '';
    
    // Валидация
    if (action === 'reject' && !reason) {
        alert('Необходимо указать причину отклонения');
        return;
    }
    
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    formData.append('notes', notes);
    if (reason) formData.append('reason', reason);
    
    let url = '';
    if (action === 'approve') {
        url = `/admin-panel/moderation/${currentQueueId}/approve/`;
    } else if (action === 'reject') {
        url = `/admin-panel/moderation/${currentQueueId}/reject/`;
    }
    
    fetch(url, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('moderationModal')).hide();
            showAlert('success', data.message);
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showAlert('danger', data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', 'Произошла ошибка при выполнении операции');
    });
}

// Назначение модератора
function assignModerator(queueId) {
    currentQueueId = queueId;
    const modal = new bootstrap.Modal(document.getElementById('assignModal'));
    const confirmBtn = document.getElementById('confirmAssignBtn');
    
    confirmBtn.onclick = function() {
        const moderatorId = document.getElementById('moderatorSelect').value;
        
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        formData.append('moderator_id', moderatorId);
        
        fetch(`/admin-panel/moderation/${currentQueueId}/assign/`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('assignModal')).hide();
                showAlert('success', data.message);
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showAlert('danger', data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('danger', 'Произошла ошибка при назначении модератора');
        });
    };
    
    modal.show();
}

// Массовое назначение
function bulkAssign(moderatorId) {
    const selectedItems = Array.from(document.querySelectorAll('.queue-item-checkbox:checked')).map(cb => cb.value);
    
    if (selectedItems.length === 0) {
        showAlert('warning', 'Выберите элементы для назначения');
        return;
    }
    
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    formData.append('moderator_id', moderatorId);
    selectedItems.forEach(id => formData.append('queue_ids[]', id));
    
    fetch('/admin-panel/moderation/bulk-assign/', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showAlert('danger', data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', 'Произошла ошибка при массовом назначении');
    });
}

// Автоматическое обнаружение подозрительного контента
function detectSuspiciousContent() {
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch('/admin-panel/moderation/detect-suspicious/', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            showAlert('danger', data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', 'Произошла ошибка при автопоиске');
    });
}

// Показать уведомление
function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.content-wrapper');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Автоматически скрываем через 5 секунд
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
document.getElementById('assignModal')).hide();
                showAlert('success', data.message);
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showAlert('danger', data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('danger', 'An error occurred while assigning moderator');
        });
    };
    
    modal.show();
}

// Bulk assignment
function bulkAssign(moderatorId) {
    const selectedItems = Array.from(document.querySelectorAll('.queue-item-checkbox:checked')).map(cb => cb.value);
    
    if (selectedItems.length === 0) {
        showAlert('warning', 'Please select items to assign');
        return;
    }
    
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    formData.append('moderator_id', moderatorId);
    selectedItems.forEach(id => formData.append('queue_ids[]', id));
    
    fetch('/admin-panel/moderation/bulk-assign/', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showAlert('danger', data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', 'An error occurred during bulk assignment');
    });
}

// Automatic suspicious content detection
function detectSuspiciousContent() {
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch('/admin-panel/moderation/detect-suspicious/', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            showAlert('danger', data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', 'An error occurred during auto detection');
    });
}

// Show alert notification
function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.content-wrapper');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto hide after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}