{% extends 'admin_panel/base.html' %}

{% block title %}Управление чатами - HandshakeMe Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-0">Управление чатами</h1>
        <p class="text-muted">Просмотр и модерация чатов пользователей</p>
    </div>
</div>

<!-- Статистика -->
<div class="row mb-4">
    <div class="col-md-2">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-primary">{{ stats.total_chats }}</h5>
                <p class="card-text small">Всего чатов</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-success">{{ stats.active_chats }}</h5>
                <p class="card-text small">Активные</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-danger">{{ stats.blocked_chats }}</h5>
                <p class="card-text small">Заблокированные</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-info">{{ stats.direct_chats }}</h5>
                <p class="card-text small">Личные</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-warning">{{ stats.project_chats }}</h5>
                <p class="card-text small">Проектные</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-secondary">{{ stats.group_chats }}</h5>
                <p class="card-text small">Групповые</p>
            </div>
        </div>
    </div>
</div>

<!-- Фильтры -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Поиск</label>
                <input type="text" name="search" class="form-control" 
                       placeholder="ID чата, участники..." 
                       value="{{ current_filters.search }}">
            </div>
            <div class="col-md-2">
                <label class="form-label">Тип чата</label>
                <select name="room_type" class="form-select">
                    <option value="">Все типы</option>
                    {% for value, label in room_type_choices %}
                    <option value="{{ value }}" {% if current_filters.room_type == value %}selected{% endif %}>
                        {{ label }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Статус</label>
                <select name="status" class="form-select">
                    <option value="">Все статусы</option>
                    <option value="active" {% if current_filters.status == 'active' %}selected{% endif %}>Активные</option>
                    <option value="blocked" {% if current_filters.status == 'blocked' %}selected{% endif %}>Заблокированные</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Дата создания</label>
                <select name="date_range" class="form-select">
                    <option value="">Все даты</option>
                    <option value="today" {% if current_filters.date_range == 'today' %}selected{% endif %}>Сегодня</option>
                    <option value="week" {% if current_filters.date_range == 'week' %}selected{% endif %}>Неделя</option>
                    <option value="month" {% if current_filters.date_range == 'month' %}selected{% endif %}>Месяц</option>
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-outline-primary me-2">Применить</button>
                <a href="{% url 'admin_panel:chats' %}" class="btn btn-outline-secondary">Сбросить</a>
            </div>
        </form>
    </div>
</div>
<!-- Массовые действия -->
<div class="card mb-3" id="bulk-actions" style="display: none;">
    <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <span id="selected-count">0</span> чатов выбрано
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-success" onclick="showBulkMessageModal()">
                    <i class="bi bi-chat-text me-2"></i>Отправить сообщение
                </button>
                <button type="button" class="btn btn-warning" onclick="bulkBlockChats()">
                    <i class="bi bi-lock me-2"></i>Заблокировать
                </button>
                <button type="button" class="btn btn-outline-success" onclick="bulkUnblockChats()">
                    <i class="bi bi-unlock me-2"></i>Разблокировать
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Список чатов -->
<div class="card">
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th width="40">
                        <input type="checkbox" id="select-all" class="form-check-input">
                    </th>
                    <th>ID</th>
                    <th>Название/Участники</th>
                    <th>Тип</th>
                    <th>Статус</th>
                    <th>Сообщений</th>
                    <th>Последнее сообщение</th>
                    <th>Создан</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for chat in chats %}
                <tr>
                    <td>
                        <input type="checkbox" class="form-check-input chat-checkbox" 
                               value="{{ chat.id }}" data-status="{% if chat.is_active %}active{% else %}blocked{% endif %}">
                    </td>
                    <td>
                        <code>#{{ chat.id }}</code>
                    </td>
                    <td>
                        <div>
                            <strong>{{ chat }}</strong>
                            {% if chat.room_type == 'direct' %}
                            <br>
                            <small class="text-muted">
                                {% for participant in chat.participants.all|slice:":2" %}
                                    {{ participant.get_full_name|default:participant.email }}{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            </small>
                            {% elif chat.project %}
                            <br>
                            <small class="text-muted">Проект: {{ chat.project.title }}</small>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        <span class="badge bg-{% if chat.room_type == 'direct' %}primary{% elif chat.room_type == 'project' %}info{% else %}secondary{% endif %}">
                            {{ chat.get_room_type_display }}
                        </span>
                    </td>
                    <td>
                        {% if chat.is_active %}
                        <span class="badge bg-success">Активный</span>
                        {% else %}
                        <span class="badge bg-danger">Заблокирован</span>
                        {% endif %}
                    </td>
                    <td>{{ chat.message_count|default:0 }}</td>
                    <td>
                        {% if chat.last_message_time %}
                        {{ chat.last_message_time|date:"d.m.Y H:i" }}
                        {% else %}
                        <span class="text-muted">Нет сообщений</span>
                        {% endif %}
                    </td>
                    <td>{{ chat.created_at|date:"d.m.Y H:i" }}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <a href="{% url 'admin_panel:chat_detail' chat.id %}" 
                               class="btn btn-outline-info" title="Просмотр">
                                <i class="bi bi-eye"></i>
                            </a>
                            {% if chat.is_active %}
                            <button class="btn btn-outline-warning" 
                                    onclick="blockChat({{ chat.id }}, '{{ chat }}')"
                                    title="Заблокировать">
                                <i class="bi bi-lock"></i>
                            </button>
                            {% else %}
                            <button class="btn btn-outline-success" 
                                    onclick="unblockChat({{ chat.id }}, '{{ chat }}')"
                                    title="Разблокировать">
                                <i class="bi bi-unlock"></i>
                            </button>
                            {% endif %}
                            <button class="btn btn-outline-primary" 
                                    onclick="showMessageModal({{ chat.id }}, '{{ chat }}')"
                                    title="Отправить сообщение">
                                <i class="bi bi-chat-text"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="9" class="text-center py-4">
                        <i class="bi bi-chat display-4 text-muted mb-2"></i>
                        <p class="text-muted">Чаты не найдены</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Пагинация -->
{% if page_obj.has_other_pages %}
<nav class="mt-4">
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Предыдущая</a>
        </li>
        {% endif %}
        
        {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
        <li class="page-item active">
            <span class="page-link">{{ num }}</span>
        </li>
        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
        <li class="page-item">
            <a class="page-link" href="?page={{ num }}">{{ num }}</a>
        </li>
        {% endif %}
        {% endfor %}
        
        {% if page_obj.has_next %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}">Следующая</a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}
<!-- Модальное окно отправки сообщения -->
<div class="modal fade" id="messageModal" tabindex="-1">

<!-- Модальное окно отправки сообщения -->
<div class="modal fade" id="messageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Отправить системное сообщение</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="messageForm">
                    <div class="mb-3">
                        <label class="form-label">Шаблон сообщения</label>
                        <select class="form-select" id="messageTemplate" onchange="loadTemplate()">
                            <option value="">Выберите шаблон или введите сообщение</option>
                            {% for template in message_templates %}
                            <option value="{{ template.id }}" data-content="{{ template.content }}">
                                {{ template.name }} ({{ template.get_category_display }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Сообщение</label>
                        <textarea class="form-control" id="messageContent" rows="4" 
                                  placeholder="Введите текст сообщения..."></textarea>
                    </div>
                    <input type="hidden" id="chatId">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="sendMessage()">Отправить</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% include 'admin_panel/chats/list_js.html' %}