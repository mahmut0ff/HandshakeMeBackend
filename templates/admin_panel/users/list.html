{% extends 'admin_panel/base.html' %}

{% block title %}Пользователи - HandshakeMe Админ-панель{% endblock %}

{% block page_title %}Управление пользователями{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active">Пользователи</li>
{% endblock %}

{% block content %}
<!-- Filters Card -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0 d-flex align-items-center">
            <i class="bi bi-funnel me-2 text-primary"></i>
            Фильтры и поиск
        </h5>
    </div>
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-4">
                {{ search_form.search.label_tag }}
                {{ search_form.search }}
            </div>
            <div class="col-md-2">
                {{ search_form.status.label_tag }}
                {{ search_form.status }}
            </div>
            <div class="col-md-2">
                {{ search_form.user_type.label_tag }}
                {{ search_form.user_type }}
            </div>
            <div class="col-md-2">
                {{ search_form.date_joined.label_tag }}
                {{ search_form.date_joined }}
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="bi bi-search me-1"></i>
                    Поиск
                </button>
                <a href="{% url 'admin_panel:users' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-x-circle me-1"></i>
                    Сброс
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Users Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0 d-flex align-items-center">
            <i class="bi bi-people me-2 text-primary"></i>
            Пользователи
            <span class="badge bg-primary ms-2">{{ page_obj.paginator.count }}</span>
        </h5>
        <div class="btn-group">
            <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="bi bi-download me-1"></i>
                Экспорт
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#"><i class="bi bi-file-earmark-excel me-2"></i>Excel</a></li>
                <li><a class="dropdown-item" href="#"><i class="bi bi-file-earmark-text me-2"></i>CSV</a></li>
            </ul>
        </div>
    </div>
    <div class="card-body p-0">
        {% if users %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Пользователь</th>
                            <th>Тип</th>
                            <th>Статус</th>
                            <th>Дата регистрации</th>
                            <th>Последняя активность</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    {% if user.avatar %}
                                        <img src="{{ user.avatar.url }}" alt="Avatar" class="avatar me-3">
                                    {% else %}
                                        <img src="https://ui-avatars.com/api/?name={{ user.get_full_name|default:user.email|urlencode }}&background=4f46e5&color=fff&size=40" 
                                             alt="Avatar" class="avatar me-3">
                                    {% endif %}
                                    <div>
                                        <div class="fw-semibold">{{ user.get_full_name|default:user.email }}</div>
                                        <small class="text-muted">{{ user.email }}</small>
                                        {% if user.phone_number %}
                                            <br><small class="text-muted">{{ user.phone_number }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>
                                {% if user.user_type == 'contractor' %}
                                    <span class="badge bg-info">Подрядчик</span>
                                {% else %}
                                    <span class="badge bg-primary">Клиент</span>
                                {% endif %}
                                {% if user.is_verified %}
                                    <i class="bi bi-patch-check-fill text-success ms-1" title="Верифицирован"></i>
                                {% endif %}
                            </td>
                            <td>
                                {% if user.is_active %}
                                    <span class="badge bg-success">Активен</span>
                                {% else %}
                                    <span class="badge bg-danger">Заблокирован</span>
                                {% endif %}
                                {% if user.is_online %}
                                    <i class="bi bi-circle-fill text-success ms-1" style="font-size: 8px;" title="Онлайн"></i>
                                {% endif %}
                            </td>
                            <td>
                                <small class="text-muted">{{ user.date_joined|date:"d.m.Y H:i" }}</small>
                            </td>
                            <td>
                                <small class="text-muted">{{ user.last_seen|timesince }} назад</small>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="{% url 'admin_panel:user_detail' user.pk %}" class="btn btn-outline-primary" title="Просмотр">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    {% if user.is_active %}
                                        <button class="btn btn-outline-warning" title="Заблокировать" onclick="confirmAction('ban', {{ user.pk }}, '{{ user.get_full_name|default:user.email }}')">
                                            <i class="bi bi-person-x"></i>
                                        </button>
                                    {% else %}
                                        <button class="btn btn-outline-success" title="Разблокировать" onclick="confirmAction('unban', {{ user.pk }}, '{{ user.get_full_name|default:user.email }}')">
                                            <i class="bi bi-person-check"></i>
                                        </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            {% if page_obj.has_other_pages %}
                <div class="card-footer">
                    <nav aria-label="Пагинация пользователей">
                        <ul class="pagination justify-content-center mb-0">
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.user_type %}&user_type={{ request.GET.user_type }}{% endif %}{% if request.GET.date_joined %}&date_joined={{ request.GET.date_joined }}{% endif %}">Первая</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.user_type %}&user_type={{ request.GET.user_type }}{% endif %}{% if request.GET.date_joined %}&date_joined={{ request.GET.date_joined }}{% endif %}">Предыдущая</a>
                                </li>
                            {% endif %}
                            
                            <li class="page-item active">
                                <span class="page-link">{{ page_obj.number }} из {{ page_obj.paginator.num_pages }}</span>
                            </li>
                            
                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.user_type %}&user_type={{ request.GET.user_type }}{% endif %}{% if request.GET.date_joined %}&date_joined={{ request.GET.date_joined }}{% endif %}">Следующая</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.user_type %}&user_type={{ request.GET.user_type }}{% endif %}{% if request.GET.date_joined %}&date_joined={{ request.GET.date_joined }}{% endif %}">Последняя</a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
            {% endif %}
        {% else %}
            <div class="text-center py-5">
                <div class="stats-icon bg-primary bg-opacity-10 text-primary mx-auto mb-3" style="width: 64px; height: 64px; font-size: 1.5rem;">
                    <i class="bi bi-people"></i>
                </div>
                <h5 class="text-muted">Пользователи не найдены</h5>
                <p class="text-muted">Попробуйте изменить параметры поиска</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalTitle">Подтверждение действия</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="confirmModalBody">
                <!-- Content will be filled by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger" id="confirmActionBtn">Подтвердить</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function confirmAction(action, userId, userName) {
    const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
    const title = document.getElementById('confirmModalTitle');
    const body = document.getElementById('confirmModalBody');
    const confirmBtn = document.getElementById('confirmActionBtn');
    
    let actionText = '';
    
    if (action === 'ban') {
        actionText = 'заблокировать';
        title.textContent = 'Блокировка пользователя';
        confirmBtn.className = 'btn btn-warning';
    } else if (action === 'unban') {
        actionText = 'разблокировать';
        title.textContent = 'Разблокировка пользователя';
        confirmBtn.className = 'btn btn-success';
    }
    
    body.innerHTML = `
        <p>Вы уверены, что хотите <strong>${actionText}</strong> пользователя:</p>
        <p class="text-center"><strong>${userName}</strong></p>
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Это действие будет записано в журнал аудита.
        </div>
    `;
    
    confirmBtn.onclick = function() {
        console.log(`${action} user ${userId}`);
        modal.hide();
        
        // Show success notification
        const alert = document.createElement('div');
        alert.className = 'alert alert-success alert-dismissible fade show';
        alert.innerHTML = `
            Пользователь ${userName} успешно ${action === 'ban' ? 'заблокирован' : 'разблокирован'}.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.content-wrapper').insertBefore(alert, document.querySelector('.content-wrapper').firstChild);
        
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 5000);
    };
    
    modal.show();
}
</script>
{% endblock %}